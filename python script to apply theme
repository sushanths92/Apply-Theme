import os
import shutil
import json

# Determine the path to the Themer folder
current_dir = os.path.dirname(os.path.abspath(__file__))
themer_folder = current_dir

# Define paths within the Themer folder
standard_resources_folder = os.path.join(themer_folder, 'standard_settings', 'KLA Power BI Template Visuals.Report', 'StaticResources', 'RegisteredResources')

# Find the dynamic folder name within the pbi_file_in_pbip_format folder
pbi_file_folder = os.path.join(themer_folder, 'pbi_file_in_pbip_format')
dynamic_pbi_folder = None

for item in os.listdir(pbi_file_folder):
    item_path = os.path.join(pbi_file_folder, item)
    if os.path.isdir(item_path) and item.endswith('.Report'):
        dynamic_pbi_folder = item_path
        break

if dynamic_pbi_folder is None:
    raise FileNotFoundError("No folder ending with '.Report' found in the pbi_file_in_pbip_format directory.")

pbi_resources_folder = os.path.join(dynamic_pbi_folder, 'StaticResources', 'RegisteredResources')
report_json_path = os.path.join(dynamic_pbi_folder, 'definition', 'report.json')

def copy_registered_resources():
    if not os.path.exists(pbi_resources_folder):
        os.makedirs(pbi_resources_folder)
        
    # Copy all files from the standard resources folder to the pbi resources folder
    for item in os.listdir(standard_resources_folder):
        s = os.path.join(standard_resources_folder, item)
        d = os.path.join(pbi_resources_folder, item)
        if os.path.isfile(s):
            shutil.copy2(s, d)
        elif os.path.isdir(s):
            shutil.copytree(s, d, dirs_exist_ok=True)

def update_report_json():
    with open(report_json_path, 'r') as file:
        data = json.load(file)
    
    # Debugging: Print current RegisteredResources items
    print("Original RegisteredResources items:")
    for package in data.get('resourcePackages', []):
        if package['name'] == 'RegisteredResources':
            for item in package.get('items', []):
                print(f"Name: {item['name']}, Type: {item['type']}")

            # Get current items in RegisteredResources
            existing_items = {item['name']: item for item in package.get('items', [])}
            
            # Add new items to the RegisteredResources section
            new_items = []
            for item in os.listdir(pbi_resources_folder):
                item_path = os.path.join(pbi_resources_folder, item)
                if os.path.isfile(item_path):
                    resource_type = 'Image' if item.lower().endswith(('.png', '.svg', '.jpg', '.jpeg')) else 'File'
                    if item.lower().endswith('.json'):
                        resource_type = 'CustomTheme'
                    new_item = {
                        'name': item,
                        'path': item,
                        'type': resource_type
                    }
                    new_items.append(new_item)
            
            # Debugging: Print new items to be added
            print("New items to be added:")
            for item in new_items:
                print(f"Name: {item['name']}, Type: {item['type']}")
            
            # Update the items list in RegisteredResources
            for item in new_items:
                if item['name'] not in existing_items:
                    package['items'].append(item)
            
            break
    
    # Write the updated JSON data back to the file
    with open(report_json_path, 'w') as file:
        json.dump(data, file, indent=4)

if __name__ == "__main__":
    copy_registered_resources()
    update_report_json()
